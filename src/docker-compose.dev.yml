# Location: src/docker-compose.dev.yml
# This file manages the shared infrastructure (Mosquitto, Home Assistant) and includes integrations.

include:
  - HAMQTT.Integration.Oxxio/docker-compose.dev.yml
services:
  # The Shared MQTT Broker
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mqtt_broker
    restart: unless-stopped
    ports:
      - "1883:1883"
      - "9001:9001"
    # Load .env from same directory (src/)
    env_file:
      - .env
    environment:
      - MQTT_USERNAME
      - MQTT_PASSWORD
    # Dynamically create config and password file on startup
    command: >
      sh -c "echo 'per_listener_settings true' > /mosquitto/config/mosquitto.conf &&
             echo 'listener 1883' >> /mosquitto/config/mosquitto.conf &&
             echo 'allow_anonymous false' >> /mosquitto/config/mosquitto.conf &&
             echo 'password_file /mosquitto/config/passwd' >> /mosquitto/config/mosquitto.conf &&
             touch /mosquitto/config/passwd &&
             mosquitto_passwd -b /mosquitto/config/passwd \$\ \$\ &&
             /usr/sbin/mosquitto -c /mosquitto/config/mosquitto.conf"
    networks:
      - hamqtt-integration_network
    volumes:
      - mosquitto_data:/mosquitto/data
      - mosquitto_log:/mosquitto/log

  # Home Assistant (Local Dev)
  homeassistant:
    container_name: homeassistant
    image: "ghcr.io/home-assistant/home-assistant:stable"
    volumes:
      # CHANGED: Map config from src/ha_config (sibling directory)
      - ./ha_config:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    ports:
      - "8123:8123"
    networks:
      - hamqtt-integration_network
    depends_on:
      - mosquitto

networks:
  hamqtt-integration_network:
    name: hamqtt-integration_network
    driver: bridge

volumes:
  mosquitto_data:
  mosquitto_log:





